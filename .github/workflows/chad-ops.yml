############################################################
# CHAD Ops â€” BlueFalconInk LLC Agent Orchestration
#
# Runs on schedule (weekly) or manual dispatch.
# 1. Audits all repos â†’ produces audit_report.json
# 2. Generates CHAD advisory dashboard â†’ dashboard.html
# 3. Optionally runs cleanup agent (dry-run by default)
# 4. Commits reports + dashboard back to this repo
#
# Secrets required:
#   GH_PAT (Personal Access Token with repo+workflow scope â€” sees private repos)
#   GEMINI_API_KEY (for AI-assisted analysis)
############################################################
name: "CHAD Ops â€” Agent Orchestration"

on:
  schedule:
    - cron: "0 6 * * 1"       # Every Monday at 06:00 UTC
  workflow_dispatch:
    inputs:
      run_cleanup:
        description: "Run cleanup agent (archive stale repos, fix branding)"
        required: false
        default: "dry-run"
        type: choice
        options:
          - "dry-run"
          - "execute"
          - "skip"
      cleanup_actions:
        description: "Cleanup actions to perform"
        required: false
        default: "all"
        type: choice
        options:
          - "all"
          - "archive"
          - "brand"
          - "deploy"

permissions:
  contents: write
  actions: read
  pull-requests: read

env:
  GITHUB_OWNER: "koreric75"
  EXTRA_ORGS: "bluefalconink"
  PYTHON_VERSION: "3.11"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Audit all repos
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  audit:
    name: "ğŸ” Repo Audit"
    runs-on: ubuntu-latest
    outputs:
      api_calls: ${{ steps.audit.outputs.api_calls }}
      total_repos: ${{ steps.audit.outputs.total_repos }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Setup Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install requests

      - name: Run Repo Auditor
        id: audit
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/repo_auditor.py \
            --owner "${{ env.GITHUB_OWNER }}" \
            --extra-orgs "${{ env.EXTRA_ORGS }}" \
            --output docs/audit_report.json
          
          # Extract summary for job output
          echo "api_calls=$(python -c "import json; d=json.load(open('docs/audit_report.json')); print(d.get('api_calls_used',0))")" >> $GITHUB_OUTPUT
          echo "total_repos=$(python -c "import json; d=json.load(open('docs/audit_report.json')); print(d.get('summary',{}).get('total_repos',0))")" >> $GITHUB_OUTPUT

      - name: Upload audit report
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4
        with:
          name: audit-report
          path: docs/audit_report.json
          retention-days: 90

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Generate CHAD Dashboard
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  dashboard:
    name: "ğŸ“Š CHAD Dashboard"
    needs: audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Setup Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download audit report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4
        with:
          name: audit-report
          path: docs/

      - name: Generate Dashboard
        run: |
          python .github/scripts/dashboard_generator.py \
            --input docs/audit_report.json \
            --output docs/dashboard.html

      - name: Upload dashboard
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4
        with:
          name: chad-dashboard
          path: |
            docs/dashboard.html
            docs/audit_report.json
          retention-days: 90

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Cleanup Agent (optional)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cleanup:
    name: "ğŸ§¹ Cleanup Agent"
    needs: [audit, dashboard]
    if: ${{ github.event.inputs.run_cleanup != 'skip' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Setup Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install requests

      - name: Download audit report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4
        with:
          name: audit-report
          path: docs/

      - name: Run Cleanup Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          MODE="${{ github.event.inputs.run_cleanup || 'dry-run' }}"
          ACTIONS="${{ github.event.inputs.cleanup_actions || 'all' }}"
          
          if [ "$MODE" = "execute" ]; then
            python .github/scripts/cleanup_agent.py \
              --owner "${{ env.GITHUB_OWNER }}" \
              --report docs/audit_report.json \
              --execute \
              --action $ACTIONS
          else
            python .github/scripts/cleanup_agent.py \
              --owner "${{ env.GITHUB_OWNER }}" \
              --report docs/audit_report.json \
              --dry-run \
              --action $ACTIONS
          fi

      - name: Upload cleanup log
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4
        with:
          name: cleanup-log
          path: docs/cleanup_log.json
          retention-days: 90

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Commit reports back to repo
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  commit:
    name: "ğŸ’¾ Commit Reports"
    needs: [audit, dashboard]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4
        with:
          path: artifacts/

      - name: Commit reports and dashboard
        run: |
          mkdir -p docs
          
          # Copy artifacts
          # Audit data is NOT committed to the public repo.
          # Reports are available as workflow artifacts and served
          # at runtime via the Cloud Run dashboard (/api/refresh).
          REPOS="${{ needs.audit.outputs.total_repos }}"
          CALLS="${{ needs.audit.outputs.api_calls }}"
          echo "âœ… CHAD audit complete â€” ${REPOS} repos, ${CALLS} API calls"
          echo "   Artifacts uploaded (not committed to public repo)"

      - name: Trigger Cloud Run dashboard refresh
        env:
          DASHBOARD_URL: "https://chad-dashboard-42380604425.us-central1.run.app"
        run: |
          echo "Triggering CHAD dashboard refresh at ${DASHBOARD_URL}/api/refresh ..."
          HTTP_CODE=$(curl -s -o /tmp/refresh_response.json -w "%{http_code}" \
            -X POST "${DASHBOARD_URL}/api/refresh" \
            -H "Content-Type: application/json" \
            -d '{"owner": "'"${{ env.GITHUB_OWNER }}"'"}' \
            --max-time 150)
          echo "Response code: ${HTTP_CODE}"
          cat /tmp/refresh_response.json || true
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Dashboard refreshed successfully"
          else
            echo "âš ï¸ Dashboard refresh returned ${HTTP_CODE} â€” dashboard may use stale data"
          fi
