flowchart TB
    %% Architect AI Pro — System Architecture
    %% BlueFalconInk LLC

    %% ── FLOW 1: Diagram Generation Pipeline ──

    subgraph Flow1["① Diagram Generation — on every code push"]
        direction LR
        Push(["Developer pushes<br/>code to main"])
        Trigger["GitHub Actions<br/>arch-sync.yml"]
        Scan["generate_diagram.py<br/>Scans repo file tree"]
        Config[("ARCHITECT_CONFIG.json<br/>Building codes")]
        Guard["prompt_guard.py<br/>Sanitize + block injection"]
        Gemini(["Gemini 2.5 Flash<br/>Generates Mermaid"])
        Foreman["foreman_audit.py<br/>Compliance check"]
        Pass{"Audit<br/>passed?"}
        Fix["Auto-remediate<br/>via Gemini re-prompt"]
        Export["Export Plugins<br/>Draw.io, PNG, Excalidraw"]
        Save["Commit to repo<br/>docs/architecture.*"]

        Push --> Trigger --> Scan
        Config -.-> Scan
        Scan --> Guard --> Gemini --> Foreman --> Pass
        Pass -- Yes --> Export --> Save
        Pass -- No --> Fix --> Gemini
    end

    %% ── FLOW 2: CHAD Governance — Weekly ──

    subgraph Flow2["② CHAD Governance — weekly Monday 06:00 UTC"]
        direction LR
        Cron(["Scheduled or<br/>manual trigger"])
        Audit["repo_auditor.py<br/>Scan all GitHub repos"]
        GH(["GitHub API"])
        Report[("audit_report.json")]
        DashGen["dashboard_generator.py<br/>Build HTML dashboard"]
        HTML[("dashboard.html")]
        Clean["cleanup_agent.py<br/>Archive, fix branding"]
        SaveCHAD["Commit reports<br/>to repo"]

        Cron --> Audit --> GH --> Report
        Report --> DashGen --> HTML --> SaveCHAD
        Report --> Clean -.-> SaveCHAD
    end

    %% ── FLOW 3: Deployed Services ──

    subgraph Flow3["③ Cloud Run Services"]
        direction LR
        User(["Browser"])

        subgraph Dash["CHAD Dashboard — Flask"]
            DashApp["dashboard-server.py<br/>Audit dashboard + API"]
            DashData[("dashboard.html<br/>audit_report.json")]
        end

        subgraph Gallery["Arch Gallery — FastAPI"]
            GallApp["gallery/main.py<br/>Diagram viewer"]
            Cache[("In-memory cache<br/>10-min TTL")]
        end

        User -- dashboard URL --> DashApp --> DashData
        User -- gallery URL --> GallApp --> Cache
    end

    %% ── FLOW 4: Security Scans ──

    subgraph Flow4["④ Security Scans — on every push"]
        direction LR
        SPush(["Push to main"])
        SAST["Bandit SAST"]
        Deps["pip-audit + Safety"]
        Cont["Trivy container scan"]
        SARIF[("GitHub Security Tab<br/>SARIF reports")]

        SPush --> SAST --> SARIF
        SPush --> Deps --> SARIF
        SPush --> Cont --> SARIF
    end

    %% ── Cross-flow connections ──

    Save -.-> GallApp
    SaveCHAD -.-> DashApp
    DashApp -.-> Audit

    %% ── Infrastructure ──

    subgraph Infra["Infrastructure"]
        direction LR
        TF["Terraform"]
        AR[("Artifact Registry")]
        CB["Cloud Build"]
        TF -.-> AR
        CB --> AR
    end

    CB -.-> DashApp
    CB -.-> GallApp

    %% ── Styles ──

    classDef trigger fill:#F59E0B,color:#1F2937,stroke:#D97706,stroke-width:2px
    classDef process fill:#1E3A5F,color:#BFDBFE,stroke:#3B82F6
    classDef api fill:#7C3AED,color:#EDE9FE,stroke:#8B5CF6,stroke-width:2px
    classDef data fill:#0F172A,color:#E2E8F0,stroke:#475569
    classDef decide fill:#DC2626,color:#FEE2E2,stroke:#EF4444,stroke-width:2px
    classDef sec fill:#065F46,color:#D1FAE5,stroke:#10B981
    classDef infra fill:#374151,color:#F9FAFB,stroke:#6B7280

    class Push,Cron,User,SPush trigger
    class Trigger,Scan,Guard,Foreman,Fix,Export,Save process
    class Audit,DashGen,Clean,SaveCHAD,DashApp,GallApp process
    class Gemini,GH api
    class Config,Report,HTML,DashData,Cache,SARIF data
    class Pass decide
    class SAST,Deps,Cont sec
    class TF,AR,CB infra